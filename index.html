<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lanco Hill</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial Black', Arial, sans-serif;
      background-color: #000;
    }

    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Controles mejorados */
    .controles {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 1px 38px;
      box-sizing: border-box;
      z-index: 1;
      pointer-events: none;
    align-items: center;
    }

    .controles-movimiento, .controles-acciones {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 0px;
      pointer-events: auto;
          justify-items: center;
    }

    .controles-movimiento {
      margin-right: 0;
    }

    button {
      padding: 0;
      font-size: 1.2rem;
      background: rgba(30, 30, 30, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      cursor: pointer;
      color: white;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transition: all 0.1s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    button:active {
      transform: scale(0.9);
      background: rgba(70, 70, 70, 0.9);
    }

    /* Posicionamiento específico de los botones */
    #adelante {
      grid-column: 2;
      grid-row: 1;
    }

    #izquierda {
      grid-column: 1;
      grid-row: 2;
    }

    #derecha {
      grid-column: 3;
      grid-row: 2;
    }

    #atras {
      grid-column: 2;
      grid-row: 3;
    }

    /* Controles de acciones (derecha) */
    .controles-acciones {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(3, 1fr);
      align-items: center;
    }

    #accion {
      grid-column: 1 / span 2;
      grid-row: 1;
      background: rgba(150, 0, 0, 0.7);
      border-radius: 30px;
      margin-bottom: 8px;
    }

    #camara-izq {
      grid-column: 1;
      grid-row: 2;
      background: rgba(0, 100, 150, 0.7);
    }

    #camara-der {
      grid-column: 2;
      grid-row: 2;
      background: rgba(0, 100, 150, 0.7);
    }

    #camara-arriba {
      grid-column: 1;
      grid-row: 3;
      background: rgba(100, 0, 150, 0.7);
    }

    #camara-abajo {
      grid-column: 2;
      grid-row: 3;
      background: rgba(100, 0, 150, 0.7);
    }

    #linterna {
      grid-column: 1 / span 2;
      grid-row: 4;
      background: rgba(150, 150, 0, 0.7);
      border-radius: 30px;
      margin-top: 8px;
    }

    /* Pantallas */
    .pantalla {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 10;
      transition: opacity 1s, transform 1s;
      text-align: center;
    }

    /* Pantalla 1: Estudios Skeleton */
    #pantalla1 {
      background: black;
    }

    /* Pantalla 2: Título del juego */
    #pantalla2 {
      background: #111;
      background-image: radial-gradient(circle at center, #300000 0%, #111 70%);
      display: none;
    }

    /* Pantalla 3: Selección de héroe */
    #pantalla3 {
      background: rgba(0, 0, 0, 0.9);
      display: none;
      overflow-y: auto;
      padding: 20px 0;
    }

    /* Pantalla 4: Juego */
    #pantalla5 {
      display: none;
    }

    .logo {
      font-size: 36px;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 5px;
    }

    .titulo-juego {
      font-size: 72px;
      font-weight: bold;
      margin-bottom: 30px;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
      letter-spacing: 3px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .subtitulo {
      font-size: 24px;
      color: #ccc;
      margin-bottom: 40px;
    }

    .seleccion-personaje {
      display: flex;
      width: 90%;
      max-width: 1200px;
      gap: 30px;
      flex-direction: column;
    }

    .personajes-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .personajes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 3px;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
    }

    .personaje {
      width: 100%;
      height: 43px;
      background: rgba(30, 30, 30, 0.7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      padding: 2px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      min-width: 0;
    }

    .personaje:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px currentColor;
    }

    .personaje.seleccionado {
      border-color: white;
      box-shadow: 0 0 20px white;
      transform: scale(1.05);
    }

    .personaje::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
      z-index: 1;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      z-index: 2;
      flex-shrink: 0;
    }

    .info-personaje {
      z-index: 2;
      min-width: 0;
    }

    .nombre-personaje {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tipo-personaje {
      font-size: 11px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Efecto de máquina de escribir */
    .maquina-escribir {
      border-right: 3px solid white;
      animation: blink 0.75s step-end infinite;
    }

    @keyframes blink {
      from, to { border-color: transparent }
      50% { border-color: white }
    }

    /* Detalles personaje */
    .detalles-personaje {
      width: 100%;
      background: rgba(20, 20, 20, 0.8);
      padding: 8px;
      border-radius: 15px;
      border: 2px solid #444;
      min-height: 300px;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
    }

    .detalles-personaje::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
      z-index: 1;
    }

    .detalles-contenido {
      position: relative;
      z-index: 2;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .detalles-personaje h2 {
      color: gold;
      font-size: 21px;
      margin-bottom: 15px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .detalles-personaje p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
      flex: 1;
      overflow-y: auto;
    }

    .detalles-personaje .stats {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      flex-wrap: wrap;
    }

    .stat {
      text-align: center;
      padding: 0 10px;
      margin: 5px 0;
      min-width: 80px;
    }

    .stat .valor {
      font-size: 24px;
      font-weight: bold;
      color: #ff5555;
      text-shadow: 0 0 5px rgba(255, 85, 85, 0.5);
    }

    .stat .nombre {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-jugar {
      padding: 12px 24px;
      font-size: 18px;
      background: linear-gradient(to bottom, #ff3333, #990000);
      border: none;
      border-radius: 50px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      align-self: center;
      margin-top: auto;
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
    }

    .btn-jugar:hover {
      transform: scale(1.05);
      background: linear-gradient(to bottom, #ff4444, #aa0000);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
    }

    /* Efecto risa fantasmal */
    .risa-fantasmal {
      position: absolute;
      opacity: 0;
      animation: risa 4s forwards;
      font-size: 24px;
      color: #ff0000;
      text-shadow: 0 0 5px #ff0000;
    }

    @keyframes risa {
      0% { opacity: 0; transform: translateY(20px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .fondo-personaje {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.2;
      z-index: 0;
      transition: opacity 0.5s;
    }

    .personaje.seleccionado .fondo-personaje {
      opacity: 0.4;
    }

    /* Nombre del jugador en el juego */
    .nombre-jugador {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      font-size: 24px;
      text-shadow: 0 0 5px black;
      z-index: 100;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
    }

    .color-personaje {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      display: inline-block;
    }

    /* Responsive para tabletas */
    @media (min-width: 600px) {
      .seleccion-personaje {
        flex-direction: row;
      }
      
      .personajes {
        grid-template-columns: 1fr;
        max-height: 500px;
      }
      
      .detalles-personaje {
        min-height: 500px;
      }
      
      .detalles-personaje h2 {
        font-size: 28px;
      }
      
      .detalles-personaje p {
        font-size: 16px;
      }
      
      .nombre-personaje {
        font-size: 18px;
      }
      
      .tipo-personaje {
        font-size: 14px;
      }
    }

    /* Responsive para escritorio */
    @media (min-width: 900px) {
      .personajes {
        width: 250px;
      }
      
      .detalles-personaje {
        padding: 43px;
      }
      
      .detalles-personaje h2 {
        font-size: 32px;
      }
      
      .stat .valor {
        font-size: 28px;
      }
      
      .stat .nombre {
        font-size: 14px;
      }
      
      .btn-jugar {
        padding: 15px 30px;
        font-size: 20px;
      }
    }

    /* Ajustes para pantallas más pequeñas */
    @media (max-width: 480px) {
      button {
        width: 50px;
        height: 50px;
        font-size: 1rem;
      }


      .personajes {
        grid-template-columns: repeat(auto-fill, minmax(134px, 1fr));
        max-height: 212px;
      }

      .personaje {
        height: 43px;
      }

      .avatar {
        width: 35px;
        height: 35px;
        font-size: 18px;
      }
      
      .nombre-jugador {
        font-size: 18px;
        top: 10px;
        left: 10px;
      }
      
      .color-personaje {
        width: 15px;
        height: 15px;
      }
    }

    /* Ajustes para tablets en orientación vertical */
    @media (min-width: 600px) and (max-width: 900px) and (orientation: portrait) {
      .personajes {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        max-height: 250px;
      }

      .personaje {
        height: 80px;
      }
    }

    /* Ajustes para pantallas grandes */
    @media (min-width: 1200px) {
      button {
        width: 70px;
        height: 70px;
        font-size: 1.5rem;
      }
    }

    /* Ajustes para orientación horizontal en móviles */
    @media (max-width: 900px) and (orientation: landscape) {
      .seleccion-personaje {
        flex-direction: row;
      }

      .personajes {
        max-height: 100vh;
        grid-template-columns: 1fr;
      }

      .detalles-personaje {
        min-height: auto;
        height: 100vh;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla 1: Estudios Skeleton -->
  <div class="pantalla" id="pantalla1">
    <div class="logo maquina-escribir">ESTUDIOS SKELETON</div>
  </div>

  <!-- Pantalla 2: Título del juego -->
  <div class="pantalla" id="pantalla2">
    <div class="titulo-juego">LANCO HILL</div>
    <div class="subtitulo">Una masacre en un pueblo olvidado</div>
    <div class="risa-fantasmal" id="risa"></div>
  </div>

  <!-- Pantalla 3: Selección de héroe -->
  <div class="pantalla" id="pantalla3">
    
    <div class="seleccion-personaje">
      <div class="personajes-container">
        <div class="personajes">
          <div class="personaje" data-personaje="paul" data-color="#3399ff">
            <div class="fondo-personaje" style="background: #3399ff;"></div>
            <div class="avatar" style="background: #3399ff;">P</div>
            <div class="info-personaje">
              <div class="nombre-personaje">PAUL</div>
              <div class="tipo-personaje">El estratega</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="joy" data-color="#ff66cc">
            <div class="fondo-personaje" style="background: #ff66cc;"></div>
            <div class="avatar" style="background: #ff66cc;">J</div>
            <div class="info-personaje">
              <div class="nombre-personaje">JOY</div>
              <div class="tipo-personaje">La veloz</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="castror" data-color="#ff5500">
            <div class="fondo-personaje" style="background: #ff5500;"></div>
            <div class="avatar" style="background: #ff5500;">C</div>
            <div class="info-personaje">
              <div class="nombre-personaje">CASTOR</div>
              <div class="tipo-personaje">El fuerte</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="jp" data-color="#ffcc00">
            <div class="fondo-personaje" style="background: #ffcc00;"></div>
            <div class="avatar" style="background: #ffcc00;">J</div>
            <div class="info-personaje">
              <div class="nombre-personaje">JP</div>
              <div class="tipo-personaje">El sabio</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="nico" data-color="#ffff00">
            <div class="fondo-personaje" style="background: #ffff00;"></div>
            <div class="avatar" style="background: #ffff00;">N</div>
            <div class="info-personaje">
              <div class="nombre-personaje">NICO</div>
              <div class="tipo-personaje">El astuto</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="kevin" data-color="#aa00ff">
            <div class="fondo-personaje" style="background: #aa00ff;"></div>
            <div class="avatar" style="background: #aa00ff;">K</div>
            <div class="info-personaje">
              <div class="nombre-personaje">KEVIN</div>
              <div class="tipo-personaje">El misterioso</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="paulo" data-color="#996633">
            <div class="fondo-personaje" style="background: #996633;"></div>
            <div class="avatar" style="background: #996633;">P</div>
            <div class="info-personaje">
              <div class="nombre-personaje">PAULO</div>
              <div class="tipo-personaje">El resistente</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Detalles del personaje seleccionado -->
      <div class="detalles-personaje" id="detalles-personaje">
        <div class="fondo-personaje" id="fondo-detalle"></div>
        <div class="detalles-contenido">
          <h2 id="nombre-detalle">SELECCIONA UN HÉROE</h2>
          <p id="historia-detalle">Cada personaje tiene habilidades únicas que te ayudarán a sobrevivir en Lanco Hill. Elige sabiamente, tu decisión podría ser la diferencia entre la vida y la muerte.</p>
          <div class="stats">
            <div class="stat">
              <div class="valor" id="fuerza">-</div>
              <div class="nombre">FUERZA</div>
            </div>
            <div class="stat">
              <div class="valor" id="velocidad">-</div>
              <div class="nombre">VELOCIDAD</div>
            </div>
            <div class="stat">
              <div class="valor" id="inteligencia">-</div>
              <div class="nombre">INTELIGENCIA</div>
            </div>
          </div>
          <button class="btn-jugar" id="btn-jugar" style="display: none;">JUGAR</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pantalla 5: Juego -->
  <div class="pantalla" id="pantalla5">
    <div class="nombre-jugador" id="nombre-jugador">
      <div class="color-personaje" id="color-jugador"></div>
      <span id="nombre-jugador-texto"></span>
    </div>
    <canvas id="juego"></canvas>
    <div class="controles">
      <!-- Controles de movimiento (izquierda) -->
      <div class="controles-movimiento">
        <button id="adelante">↑</button>
        <button id="izquierda">←</button>
        <button id="derecha">→</button>
        <button id="atras">↓</button>
      </div>
      
      <!-- Controles de acciones (derecha) -->
      <div class="controles-acciones">
        <button id="accion">A</button>
        <button id="camara-izq">←</button>
        <button id="camara-der">→</button>
        <button id="camara-arriba">↑</button>
        <button id="camara-abajo">↓</button>
        <button id="linterna">B</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/OBJLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/MTLLoader.js"></script>

<script>
  // Variables globales
  let personajeSeleccionado = null;
  let colorPersonaje = null;
  let scene, camera, renderer, personaje;
  let lastMoveSoundTime = 0;
  const moveSoundCooldown = 200; // ms
  let cameraAngle = Math.PI; // Ángulo horizontal de la cámara (modificado)
  let cameraPitch = 0.5; // Ángulo vertical de la cámara (modificado)
  let cameraDistance = 6;
  let cameraHeight = 2;

  let meson = null;
  let flashlightEnabled = true;

  // Datos de los personajes (se mantiene igual)
  const personajesData = {
    paul: {
      nombre: "PAUL",
      historia: "Paul es un estratega brillante que sobrevivió a la masacre de Lanco Hill...",
      fuerza: 6,
      velocidad: 7,
      inteligencia: 9
    },
    // ... (otros personajes se mantienen igual)
  };

  // SoundGenerator (se mantiene igual)
  class SoundGenerator {
    constructor() {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    // ... (métodos de sonido se mantienen igual)
  }

  const soundGenerator = new SoundGenerator();
  let music = null;

  // Secuencia de pantallas (se mantiene igual)
  function iniciarSecuencia() {
    soundGenerator.playExplosion();
    // ... (resto de la función se mantiene igual)
  }

  // Seleccionar personaje (se mantiene igual)
  document.querySelectorAll('.personaje').forEach(el => {
    el.addEventListener('click', function() {
      // ... (código de selección se mantiene igual)
    });
  });

  // Botón jugar (se mantiene igual)
  document.getElementById('btn-jugar').addEventListener('click', function() {
    // ... (código se mantiene igual)
  });

  // Función principal del juego MODIFICADA
  function iniciarJuego() {
    // Escena y cámara
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 2, 5);

    renderer = new THREE.WebGLRenderer({ 
      canvas: document.getElementById('juego'),
      antialias: true 
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;

    // Luces
    const hemiLight = new THREE.HemisphereLight(0x443333, 0x111122, 0.3);
    hemiLight.position.set(0, 50, 0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xaa9999, 0.5);
    dirLight.position.set(10, 20, 10);
    dirLight.castShadow = true;
    scene.add(dirLight);

    // Linterna del personaje MODIFICADA
    const flashlight = new THREE.SpotLight(0xffffff, 1, 20, Math.PI / 6, 0.5);
    flashlight.position.set(0, 1.5, 0);
    flashlight.target.position.set(0, 0, -5);
    flashlight.castShadow = true;
    scene.add(flashlight);
    scene.add(flashlight.target);

    // Suelo y objetos (se mantienen igual)
    const suelo = new THREE.Mesh(
      new THREE.PlaneGeometry(200, 200),
      new THREE.MeshStandardMaterial({ color: 0x114411 })
    );
    suelo.rotation.x = -Math.PI / 2;
    scene.add(suelo);

    // Personaje
    personaje = new THREE.Mesh(
      new THREE.BoxGeometry(1, 1.8, 1),
      new THREE.MeshStandardMaterial({ color: new THREE.Color(colorPersonaje) })
    );
    personaje.position.set(0, 0.9, 0);
    scene.add(personaje);

    // Cargar mesón (se mantiene igual)
    function cargarOBJDePrueba() {
      const objLoader = new THREE.OBJLoader();
      objLoader.load(
        './obj/meson1.obj',
        (object) => {
          meson = object;
          meson.position.set(-12, 0, 0);
          meson.scale.set(0.01, 0.01, 0.01);
          meson.rotation.set(0, Math.PI / 2, 0);
          
          meson.traverse(function(child) {
            if (child.isMesh) {
              child.material = new THREE.MeshStandardMaterial({
                color: 0xaaaaaa,
                roughness: 0.8,
                metalness: 0.2
              });
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          
          scene.add(meson);
        },
        undefined,
        (error) => {
          console.error('Error al cargar OBJ:', error);
          cargarModeloAlternativo();
        }
      );
    }

    cargarOBJDePrueba();

    // Movimiento del personaje MODIFICADO
    let input = { 
      izquierda: false, 
      derecha: false, 
      adelante: false, 
      atras: false,
      accion: false,
      camaraIzq: false,
      camaraDer: false,
      camaraArriba: false,
      camaraAbajo: false,
      linterna: false
    };

    function moverPersonaje() {
      const now = Date.now();
      const forwardX = Math.sin(cameraAngle);
      const forwardZ = Math.cos(cameraAngle);
      
      // MOVIMIENTO CORREGIDO (direcciones invertidas)
      if (input.adelante) {
        personaje.position.x -= forwardX * 0.1;
        personaje.position.z -= forwardZ * 0.1;
        if (now - lastMoveSoundTime > moveSoundCooldown) {
          soundGenerator.playMove();
          lastMoveSoundTime = now;
        }
      }
      if (input.atras) {
        personaje.position.x += forwardX * 0.1;
        personaje.position.z += forwardZ * 0.1;
        if (now - lastMoveSoundTime > moveSoundCooldown) {
          soundGenerator.playMove();
          lastMoveSoundTime = now;
        }
      }
      if (input.izquierda) {
        personaje.position.x -= forwardZ * 0.1;
        personaje.position.z += forwardX * 0.1;
      }
      if (input.derecha) {
        personaje.position.x += forwardZ * 0.1;
        personaje.position.z -= forwardX * 0.1;
      }

      // Rotación cámara
      if (input.camaraIzq) cameraAngle += 0.02;
      if (input.camaraDer) cameraAngle -= 0.02;
      if (input.camaraArriba) cameraPitch = Math.min(cameraPitch + 0.02, Math.PI/2);
      if (input.camaraAbajo) cameraPitch = Math.max(cameraPitch - 0.02, -Math.PI/2);
      
      // Linterna
      if (input.linterna) {
        flashlightEnabled = !flashlightEnabled;
        input.linterna = false;
        flashlight.intensity = flashlightEnabled ? 1 : 0;
      }
    }

    // Controles (se mantienen igual)
    ['izquierda', 'derecha', 'adelante', 'atras', 'accion', 
     'camara-izq', 'camara-der', 'camara-arriba', 'camara-abajo', 'linterna'].forEach(b => {
      const id = b.replace('-', '');
      document.getElementById(b).addEventListener('touchstart', () => input[id] = true);
      document.getElementById(b).addEventListener('touchend', () => input[id] = false);
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp') input.adelante = true;
      if (e.key === 'ArrowDown') input.atras = true;
      if (e.key === 'ArrowLeft') input.izquierda = true;
      if (e.key === 'ArrowRight') input.derecha = true;
      if (e.key === 'a') input.camaraIzq = true;
      if (e.key === 'd') input.camaraDer = true;
      if (e.key === 'w') input.camaraArriba = true;
      if (e.key === 's') input.camaraAbajo = true;
      if (e.key === 'r') input.linterna = true;
    });

    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp') input.adelante = false;
      if (e.key === 'ArrowDown') input.atras = false;
      if (e.key === 'ArrowLeft') input.izquierda = false;
      if (e.key === 'ArrowRight') input.derecha = false;
      if (e.key === 'a') input.camaraIzq = false;
      if (e.key === 'd') input.camaraDer = false;
      if (e.key === 'w') input.camaraArriba = false;
      if (e.key === 's') input.camaraAbajo = false;
    });

    // Animación MODIFICADA
    function animar() {
      requestAnimationFrame(animar);
      moverPersonaje();
      
      // Cámara en tercera persona
      const horizontalDistance = Math.cos(cameraPitch) * cameraDistance;
      const verticalDistance = Math.sin(cameraPitch) * cameraDistance;
      
      camera.position.x = personaje.position.x + Math.sin(cameraAngle) * horizontalDistance;
      camera.position.y = personaje.position.y + cameraHeight + verticalDistance;
      camera.position.z = personaje.position.z + Math.cos(cameraAngle) * horizontalDistance;
      
      camera.lookAt(personaje.position);
      
      // LINTERNA CORREGIDA
      flashlight.position.copy(personaje.position);
      flashlight.position.y += 1.5;
      
      flashlight.target.position.set(
        personaje.position.x - Math.sin(cameraAngle) * 10,
        personaje.position.y + Math.sin(cameraPitch) * 10,
        personaje.position.z - Math.cos(cameraAngle) * 10
      );
      
      renderer.render(scene, camera);
    }

    animar();

    // Manejar redimensionamiento
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  }

  // Iniciar al cargar
  window.addEventListener('load', iniciarSecuencia);
</script>
</body>
</html>
