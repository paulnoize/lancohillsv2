<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lanco Hill</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial Black', Arial, sans-serif;
      background-color: #000;
    }

    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Controles mejorados */
    .controles {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 1px 38px;
      box-sizing: border-box;
      z-index: 1;
      pointer-events: none;
    align-items: center;
    }

    .controles-movimiento, .controles-acciones {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 0px;
      pointer-events: auto;
          justify-items: center;
    }

    .controles-movimiento {
      margin-right: 0;
    }

    button {
      padding: 0;
      font-size: 1.2rem;
      background: rgba(30, 30, 30, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      cursor: pointer;
      color: white;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transition: all 0.1s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    button:active {
      transform: scale(0.9);
      background: rgba(70, 70, 70, 0.9);
    }

    /* Posicionamiento específico de los botones */
    #adelante {
      grid-column: 2;
      grid-row: 1;
    }

    #izquierda {
      grid-column: 1;
      grid-row: 2;
    }

    #derecha {
      grid-column: 3;
      grid-row: 2;
    }

    #atras {
      grid-column: 2;
      grid-row: 3;
    }

    /* Controles de acciones (derecha) */
    .controles-acciones {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(3, 1fr);
      align-items: center;
    }

    #accion {
      grid-column: 1 / span 2;
      grid-row: 1;
      background: rgba(150, 0, 0, 0.7);
      border-radius: 30px;
      margin-bottom: 8px;
    }

    #camara-izq {
      grid-column: 1;
      grid-row: 2;
      background: rgba(0, 100, 150, 0.7);
    }

    #camara-der {
      grid-column: 2;
      grid-row: 2;
      background: rgba(0, 100, 150, 0.7);
    }

    #camara-arriba {
      grid-column: 1;
      grid-row: 3;
      background: rgba(100, 0, 150, 0.7);
    }

    #camara-abajo {
      grid-column: 2;
      grid-row: 3;
      background: rgba(100, 0, 150, 0.7);
    }

    #linterna {
      grid-column: 1 / span 2;
      grid-row: 4;
      background: rgba(150, 150, 0, 0.7);
      border-radius: 30px;
      margin-top: 8px;
    }

    /* Pantallas */
    .pantalla {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 10;
      transition: opacity 1s, transform 1s;
      text-align: center;
    }

    /* Pantalla 1: Estudios Skeleton */
    #pantalla1 {
      background: black;
    }

    /* Pantalla 2: Título del juego */
    #pantalla2 {
      background: #111;
      background-image: radial-gradient(circle at center, #300000 0%, #111 70%);
      display: none;
    }

    /* Pantalla 3: Selección de héroe */
    #pantalla3 {
      background: rgba(0, 0, 0, 0.9);
      display: none;
      overflow-y: auto;
      padding: 20px 0;
    }

    /* Pantalla 4: Juego */
    #pantalla5 {
      display: none;
    }

    .logo {
      font-size: 36px;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 5px;
    }

    .titulo-juego {
      font-size: 72px;
      font-weight: bold;
      margin-bottom: 30px;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
      letter-spacing: 3px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .subtitulo {
      font-size: 24px;
      color: #ccc;
      margin-bottom: 40px;
    }

    .seleccion-personaje {
      display: flex;
      width: 90%;
      max-width: 1200px;
      gap: 30px;
      flex-direction: column;
    }

    .personajes-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .personajes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 3px;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
    }

    .personaje {
      width: 100%;
      height: 43px;
      background: rgba(30, 30, 30, 0.7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      padding: 2px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      min-width: 0;
    }

    .personaje:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px currentColor;
    }

    .personaje.seleccionado {
      border-color: white;
      box-shadow: 0 0 20px white;
      transform: scale(1.05);
    }

    .personaje::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
      z-index: 1;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      z-index: 2;
      flex-shrink: 0;
    }

    .info-personaje {
      z-index: 2;
      min-width: 0;
    }

    .nombre-personaje {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tipo-personaje {
      font-size: 11px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Efecto de máquina de escribir */
    .maquina-escribir {
      border-right: 3px solid white;
      animation: blink 0.75s step-end infinite;
    }

    @keyframes blink {
      from, to { border-color: transparent }
      50% { border-color: white }
    }

    /* Detalles personaje */
    .detalles-personaje {
      width: 100%;
      background: rgba(20, 20, 20, 0.8);
      padding: 8px;
      border-radius: 15px;
      border: 2px solid #444;
      min-height: 300px;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
    }

    .detalles-personaje::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
      z-index: 1;
    }

    .detalles-contenido {
      position: relative;
      z-index: 2;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .detalles-personaje h2 {
      color: gold;
      font-size: 21px;
      margin-bottom: 15px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .detalles-personaje p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
      flex: 1;
      overflow-y: auto;
    }

    .detalles-personaje .stats {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      flex-wrap: wrap;
    }

    .stat {
      text-align: center;
      padding: 0 10px;
      margin: 5px 0;
      min-width: 80px;
    }

    .stat .valor {
      font-size: 24px;
      font-weight: bold;
      color: #ff5555;
      text-shadow: 0 0 5px rgba(255, 85, 85, 0.5);
    }

    .stat .nombre {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-jugar {
      padding: 12px 24px;
      font-size: 18px;
      background: linear-gradient(to bottom, #ff3333, #990000);
      border: none;
      border-radius: 50px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      align-self: center;
      margin-top: auto;
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
    }

    .btn-jugar:hover {
      transform: scale(1.05);
      background: linear-gradient(to bottom, #ff4444, #aa0000);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
    }

    /* Efecto risa fantasmal */
    .risa-fantasmal {
      position: absolute;
      opacity: 0;
      animation: risa 4s forwards;
      font-size: 24px;
      color: #ff0000;
      text-shadow: 0 0 5px #ff0000;
    }

    @keyframes risa {
      0% { opacity: 0; transform: translateY(20px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .fondo-personaje {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.2;
      z-index: 0;
      transition: opacity 0.5s;
    }

    .personaje.seleccionado .fondo-personaje {
      opacity: 0.4;
    }

    /* Nombre del jugador en el juego */
    .nombre-jugador {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      font-size: 24px;
      text-shadow: 0 0 5px black;
      z-index: 100;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
    }

    .color-personaje {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      display: inline-block;
    }

    /* Responsive para tabletas */
    @media (min-width: 600px) {
      .seleccion-personaje {
        flex-direction: row;
      }
      
      .personajes {
        grid-template-columns: 1fr;
        max-height: 500px;
      }
      
      .detalles-personaje {
        min-height: 500px;
      }
      
      .detalles-personaje h2 {
        font-size: 28px;
      }
      
      .detalles-personaje p {
        font-size: 16px;
      }
      
      .nombre-personaje {
        font-size: 18px;
      }
      
      .tipo-personaje {
        font-size: 14px;
      }
    }

    /* Responsive para escritorio */
    @media (min-width: 900px) {
      .personajes {
        width: 250px;
      }
      
      .detalles-personaje {
        padding: 43px;
      }
      
      .detalles-personaje h2 {
        font-size: 32px;
      }
      
      .stat .valor {
        font-size: 28px;
      }
      
      .stat .nombre {
        font-size: 14px;
      }
      
      .btn-jugar {
        padding: 15px 30px;
        font-size: 20px;
      }
    }

    /* Ajustes para pantallas más pequeñas */
    @media (max-width: 480px) {
      button {
        width: 50px;
        height: 50px;
        font-size: 1rem;
      }


      .personajes {
        grid-template-columns: repeat(auto-fill, minmax(134px, 1fr));
        max-height: 212px;
      }

      .personaje {
        height: 43px;
      }

      .avatar {
        width: 35px;
        height: 35px;
        font-size: 18px;
      }
      
      .nombre-jugador {
        font-size: 18px;
        top: 10px;
        left: 10px;
      }
      
      .color-personaje {
        width: 15px;
        height: 15px;
      }
    }

    /* Ajustes para tablets en orientación vertical */
    @media (min-width: 600px) and (max-width: 900px) and (orientation: portrait) {
      .personajes {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        max-height: 250px;
      }

      .personaje {
        height: 80px;
      }
    }

    /* Ajustes para pantallas grandes */
    @media (min-width: 1200px) {
      button {
        width: 70px;
        height: 70px;
        font-size: 1.5rem;
      }
    }

    /* Ajustes para orientación horizontal en móviles */
    @media (max-width: 900px) and (orientation: landscape) {
      .seleccion-personaje {
        flex-direction: row;
      }

      .personajes {
        max-height: 100vh;
        grid-template-columns: 1fr;
      }

      .detalles-personaje {
        min-height: auto;
        height: 100vh;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla 1: Estudios Skeleton -->
  <div class="pantalla" id="pantalla1">
    <div class="logo maquina-escribir">ESTUDIOS SKELETON</div>
  </div>

  <!-- Pantalla 2: Título del juego -->
  <div class="pantalla" id="pantalla2">
    <div class="titulo-juego">LANCO HILL</div>
    <div class="subtitulo">Una masacre en un pueblo olvidado</div>
    <div class="risa-fantasmal" id="risa"></div>
  </div>

  <!-- Pantalla 3: Selección de héroe -->
  <div class="pantalla" id="pantalla3">
    
    <div class="seleccion-personaje">
      <div class="personajes-container">
        <div class="personajes">
          <div class="personaje" data-personaje="paul" data-color="#3399ff">
            <div class="fondo-personaje" style="background: #3399ff;"></div>
            <div class="avatar" style="background: #3399ff;">P</div>
            <div class="info-personaje">
              <div class="nombre-personaje">PAUL</div>
              <div class="tipo-personaje">El estratega</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="joy" data-color="#ff66cc">
            <div class="fondo-personaje" style="background: #ff66cc;"></div>
            <div class="avatar" style="background: #ff66cc;">J</div>
            <div class="info-personaje">
              <div class="nombre-personaje">JOY</div>
              <div class="tipo-personaje">La veloz</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="castror" data-color="#ff5500">
            <div class="fondo-personaje" style="background: #ff5500;"></div>
            <div class="avatar" style="background: #ff5500;">C</div>
            <div class="info-personaje">
              <div class="nombre-personaje">CASTOR</div>
              <div class="tipo-personaje">El fuerte</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="jp" data-color="#ffcc00">
            <div class="fondo-personaje" style="background: #ffcc00;"></div>
            <div class="avatar" style="background: #ffcc00;">J</div>
            <div class="info-personaje">
              <div class="nombre-personaje">JP</div>
              <div class="tipo-personaje">El sabio</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="nico" data-color="#ffff00">
            <div class="fondo-personaje" style="background: #ffff00;"></div>
            <div class="avatar" style="background: #ffff00;">N</div>
            <div class="info-personaje">
              <div class="nombre-personaje">NICO</div>
              <div class="tipo-personaje">El astuto</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="kevin" data-color="#aa00ff">
            <div class="fondo-personaje" style="background: #aa00ff;"></div>
            <div class="avatar" style="background: #aa00ff;">K</div>
            <div class="info-personaje">
              <div class="nombre-personaje">KEVIN</div>
              <div class="tipo-personaje">El misterioso</div>
            </div>
          </div>
          
          <div class="personaje" data-personaje="paulo" data-color="#996633">
            <div class="fondo-personaje" style="background: #996633;"></div>
            <div class="avatar" style="background: #996633;">P</div>
            <div class="info-personaje">
              <div class="nombre-personaje">PAULO</div>
              <div class="tipo-personaje">El resistente</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Detalles del personaje seleccionado -->
      <div class="detalles-personaje" id="detalles-personaje">
        <div class="fondo-personaje" id="fondo-detalle"></div>
        <div class="detalles-contenido">
          <h2 id="nombre-detalle">SELECCIONA UN HÉROE</h2>
          <p id="historia-detalle">Cada personaje tiene habilidades únicas que te ayudarán a sobrevivir en Lanco Hill. Elige sabiamente, tu decisión podría ser la diferencia entre la vida y la muerte.</p>
          <div class="stats">
            <div class="stat">
              <div class="valor" id="fuerza">-</div>
              <div class="nombre">FUERZA</div>
            </div>
            <div class="stat">
              <div class="valor" id="velocidad">-</div>
              <div class="nombre">VELOCIDAD</div>
            </div>
            <div class="stat">
              <div class="valor" id="inteligencia">-</div>
              <div class="nombre">INTELIGENCIA</div>
            </div>
          </div>
          <button class="btn-jugar" id="btn-jugar" style="display: none;">JUGAR</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pantalla 5: Juego -->
  <div class="pantalla" id="pantalla5">
    <div class="nombre-jugador" id="nombre-jugador">
      <div class="color-personaje" id="color-jugador"></div>
      <span id="nombre-jugador-texto"></span>
    </div>
    <canvas id="juego"></canvas>
    <div class="controles">
      <!-- Controles de movimiento (izquierda) -->
      <div class="controles-movimiento">
        <button id="adelante">↑</button>
        <button id="izquierda">←</button>
        <button id="derecha">→</button>
        <button id="atras">↓</button>
      </div>
      
      <!-- Controles de acciones (derecha) -->
      <div class="controles-acciones">
        <button id="accion">A</button>
        <button id="camara-izq">←</button>
        <button id="camara-der">→</button>
        <button id="camara-arriba">↑</button>
        <button id="camara-abajo">↓</button>
        <button id="linterna">B</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/OBJLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/MTLLoader.js"></script>
  <script>
    // Variables globales
    let personajeSeleccionado = null;
    let colorPersonaje = null;
    let scene, camera, renderer, personaje;
    let lastMoveSoundTime = 0;
    const moveSoundCooldown = 200; // ms
    let cameraAngle = 0;
    let cameraPitch = 0.1; // Ángulo vertical de la cámara
    let cameraDistance = 6;
    let cameraHeight = 2;

    let meson = null;
    let flashlightEnabled = true;

    // Datos de los personajes
    const personajesData = {
      paul: {
        nombre: "PAUL",
        historia: "Paul es un estratega brillante que sobrevivió a la masacre de Lanco Hill. Su mente analítica le permite anticipar los movimientos del enemigo. Ahora regresa para vengar a su familia y descubrir la verdad detrás de los horrores que ocurren en el pueblo.",
        fuerza: 6,
        velocidad: 7,
        inteligencia: 9
      },
      joy: {
        nombre: "JOY",
        historia: "La más rápida de los hermanos Joy. Sobrevivió gracias a su agilidad y reflejos sobrenaturales. Nadie sabe cómo escapó aquella noche, pero su velocidad legendaria es la única razón por la que todavía está viva. Ahora busca respuestas en las colinas malditas.",
        fuerza: 5,
        velocidad: 10,
        inteligencia: 7
      },
      castror: {
        nombre: "CASTOR",
        historia: "Castor es la fuerza bruta del grupo. Sobrevivió a lo imposible gracias a su resistencia sobrehumana. Aunque muchos dicen que ya no es completamente humano después de lo que vivió en Lanco Hill. Su fuerza es la única esperanza contra las criaturas que habitan el pueblo.",
        fuerza: 10,
        velocidad: 4,
        inteligencia: 5
      },
      jp: {
        nombre: "JP",
        historia: "JP, el barman, conoce los secretos oscuros de Lanco Hill. Pasó años estudiando los textos antiguos que hablan de la maldición. Su conocimiento es la clave para terminar con el horror, pero cada verdad descubierta lo acerca más a la locura.",
        fuerza: 4,
        velocidad: 5,
        inteligencia: 10
      },
      nico: {
        nombre: "NICO",
        historia: "Nico es la astuta sobreviviente que siempre encuentra una salida donde otros solo ven problemas. Su ingenio rápido y su capacidad para improvisar la han mantenido con vida en las situaciones más peligrosas de Lanco Hill.",
        fuerza: 5,
        velocidad: 8,
        inteligencia: 8
      },
      kevin: {
        nombre: "KEVIN",
        historia: "Kevin es un enigma. Nadie sabe exactamente de dónde vino o cómo llegó a Lanco Hill, pero su presencia misteriosa parece afectar a las criaturas de la zona. Algunos dicen que tiene habilidades que desafían la comprensión humana.",
        fuerza: 7,
        velocidad: 6,
        inteligencia: 7
      },
      paulo: {
        nombre: "PAULO",
        historia: "Paulo es el resistente. Donde otros caen, él sigue en pie. Su capacidad para soportar el dolor y el terror lo convierten en una roca en medio de la tormenta que azota Lanco Hill.",
        fuerza: 9,
        velocidad: 5,
        inteligencia: 6
      }
    };

    // Generador de sonidos básicos (como en juegos antiguos)
    class SoundGenerator {
      constructor() {
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      // Sonido de explosión (3 notas)
      playExplosion() {
        const times = [0, 0.1, 0.2];
        const freqs = [55, 110, 220]; // Notas graves
        
        times.forEach((time, i) => {
          const osc = this.audioContext.createOscillator();
          const gain = this.audioContext.createGain();
          
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(freqs[i], this.audioContext.currentTime + time);
          
          gain.gain.setValueAtTime(0.5, this.audioContext.currentTime + time);
          gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + time + 0.5);
          
          osc.connect(gain);
          gain.connect(this.audioContext.destination);
          
          osc.start(this.audioContext.currentTime + time);
          osc.stop(this.audioContext.currentTime + time + 0.5);
        });
      }

      // Risa de terror
      playRisa() {
        const times = [0, 0.2, 0.4, 0.6, 0.8];
        const freqs = [880, 660, 440, 660, 880]; // Notas agudas
        
        times.forEach((time, i) => {
          const osc = this.audioContext.createOscillator();
          const gain = this.audioContext.createGain();
          
          osc.type = 'square';
          osc.frequency.setValueAtTime(freqs[i], this.audioContext.currentTime + time);
          
          gain.gain.setValueAtTime(0.3, this.audioContext.currentTime + time);
          gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + time + 0.15);
          
          osc.connect(gain);
          gain.connect(this.audioContext.destination);
          
          osc.start(this.audioContext.currentTime + time);
          osc.stop(this.audioContext.currentTime + time + 0.15);
        });
      }

      // Sonido de selección (moneda/arma)
      playSelect() {
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(523.25, this.audioContext.currentTime); // Do
        osc.frequency.setValueAtTime(659.25, this.audioContext.currentTime + 0.1); // Mi
        osc.frequency.setValueAtTime(783.99, this.audioContext.currentTime + 0.2); // Sol
        
        gain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
        
        osc.connect(gain);
        gain.connect(this.audioContext.destination);
        
        osc.start();
        osc.stop(this.audioContext.currentTime + 0.3);
      }

      // Sonido de movimiento (pasos)
      playMove() {
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(220, this.audioContext.currentTime);
        
        gain.gain.setValueAtTime(0.2, this.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
        
        osc.connect(gain);
        gain.connect(this.audioContext.destination);
        
        osc.start();
        osc.stop(this.audioContext.currentTime + 0.1);
      }

      // Sonido de acción
      playAction() {
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        
        osc.type = 'square';
        osc.frequency.setValueAtTime(392.00, this.audioContext.currentTime); // Sol
        osc.frequency.setValueAtTime(293.66, this.audioContext.currentTime + 0.1); // Re
        
        gain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
        
        osc.connect(gain);
        gain.connect(this.audioContext.destination);
        
        osc.start();
        osc.stop(this.audioContext.currentTime + 0.2);
      }

      // Música de fondo tenebrosa (nueva versión)
      playGameMusic() {
        const osc1 = this.audioContext.createOscillator();
        const osc2 = this.audioContext.createOscillator();
        const gain1 = this.audioContext.createGain();
        const gain2 = this.audioContext.createGain();
        
        // Oscilador principal (melodía)
        osc1.type = 'sine';
        osc1.frequency.setValueAtTime(220, this.audioContext.currentTime);
        
        // Oscilador secundario (bajo)
        osc2.type = 'sine';
        osc2.frequency.setValueAtTime(110, this.audioContext.currentTime);
        
        // Ganancia
        gain1.gain.setValueAtTime(0.05, this.audioContext.currentTime);
        gain2.gain.setValueAtTime(0.03, this.audioContext.currentTime);
        
        // Conexiones
        osc1.connect(gain1);
        osc2.connect(gain2);
        gain1.connect(this.audioContext.destination);
        gain2.connect(this.audioContext.destination);
        
        // Iniciar
        osc1.start();
        osc2.start();
        
        // Melodía tenebrosa (más simple)
        const melody = [
          { note: 220, duration: 2 }, // La
          { note: 196, duration: 1 }, // Sol
          { note: 174.61, duration: 2 }, // Fa
          { note: 146.83, duration: 1 }, // Re
          { note: 130.81, duration: 2 } // Do
        ];
        
        let currentTime = this.audioContext.currentTime;
        
        const playMelody = () => {
          melody.forEach((note, index) => {
            osc1.frequency.setValueAtTime(note.note, currentTime);
            osc2.frequency.setValueAtTime(note.note / 2, currentTime);
            currentTime += note.duration;
          });
          
          // Repetir la melodía
          setTimeout(playMelody, currentTime - this.audioContext.currentTime);
          currentTime = this.audioContext.currentTime;
        };
        
        playMelody();
        
        return { osc1, osc2, gain1, gain2 };
      }
    }

    const soundGenerator = new SoundGenerator();
    let music = null;

    // Secuencia de pantallas
    function iniciarSecuencia() {
      // Reproducir sonido de explosión
      soundGenerator.playExplosion();
      
      // Pantalla 1: Estudios Skeleton (3 segundos)
      setTimeout(() => {
        document.getElementById('pantalla1').style.opacity = '0';
        document.getElementById('pantalla2').style.display = 'flex';
        
        // Reproducir risa de terror y mostrarla
        soundGenerator.playRisa();
        document.getElementById('risa').style.animation = 'risa 4s forwards';
        
        // Pantalla 2: Título del juego (4 segundos)
        setTimeout(() => {
          document.getElementById('pantalla2').style.opacity = '0';
          setTimeout(() => {
            document.getElementById('pantalla2').style.display = 'none';
            document.getElementById('pantalla3').style.display = 'flex';
          }, 1000);
        }, 4000);
      }, 3000);
    }

    // Iniciar secuencia al cargar
    window.addEventListener('load', iniciarSecuencia);

    // Seleccionar personaje
    document.querySelectorAll('.personaje').forEach(el => {
      el.addEventListener('click', function() {
        document.querySelectorAll('.personaje').forEach(p => p.classList.remove('seleccionado'));
        this.classList.add('seleccionado');
        personajeSeleccionado = this.getAttribute('data-personaje');
        colorPersonaje = this.getAttribute('data-color');
        
        // Reproducir sonido de selección
        soundGenerator.playSelect();
        
        // Mostrar detalles del personaje
        const datos = personajesData[personajeSeleccionado];
        document.getElementById('nombre-detalle').textContent = datos.nombre;
        document.getElementById('historia-detalle').textContent = datos.historia;
        document.getElementById('fuerza').textContent = datos.fuerza;
        document.getElementById('velocidad').textContent = datos.velocidad;
        document.getElementById('inteligencia').textContent = datos.inteligencia;
        
        // Actualizar fondo del detalle
        document.getElementById('fondo-detalle').style.background = colorPersonaje;
        
        // Mostrar botón de jugar
        document.getElementById('btn-jugar').style.display = 'block';

        // Actualizar nombre del jugador
        document.getElementById('nombre-jugador-texto').textContent = datos.nombre;
        document.getElementById('color-jugador').style.backgroundColor = colorPersonaje;
      });
    });

    // Botón jugar
    document.getElementById('btn-jugar').addEventListener('click', function() {
      document.getElementById('pantalla3').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('pantalla3').style.display = 'none';
        document.getElementById('pantalla5').style.display = 'block';
        
        // Reproducir música del juego
        music = soundGenerator.playGameMusic();
        
        iniciarJuego();
      }, 1000);
    });

    // Manejar cambios de orientación
    function handleOrientationChange() {
      const isPortrait = window.innerHeight > window.innerWidth;
      
      // Ajustar controles según orientación
      if (isPortrait) {
        // Disposición vertical (móvil/tablet vertical)
        document.querySelector('.controles').style.flexDirection = 'row';
        document.querySelector('.controles').style.justifyContent = 'space-between';
      } else {
        // Disposición horizontal (tablet/PC o móvil horizontal)
        document.querySelector('.controles').style.flexDirection = 'row';
        document.querySelector('.controles').style.justifyContent = 'space-between';
      }
      
      // Redimensionar canvas si ya existe
      if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    }

    // Función principal del juego
    function iniciarJuego() {
      // Escena y cámara
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 5); // Posición inicial relativa al personaje

      renderer = new THREE.WebGLRenderer({ 
        canvas: document.getElementById('juego'),
        antialias: true 
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;

      // Luces (más tenebrosas)
      const hemiLight = new THREE.HemisphereLight(0x443333, 0x111122, 0.3);
      hemiLight.position.set(0, 50, 0);
      scene.add(hemiLight);

      const dirLight = new THREE.DirectionalLight(0xaa9999, 0.5);
      dirLight.position.set(10, 20, 10);
      dirLight.castShadow = true;
      dirLight.shadow.mapSize.width = 1024;
      dirLight.shadow.mapSize.height = 1024;
      scene.add(dirLight);

      // Luz de calle
      const streetLight = new THREE.PointLight(0xffcc99, 0.8, 15);
      streetLight.position.set(0, 5, -10);
      streetLight.castShadow = true;
      scene.add(streetLight);

      // Linterna del personaje (spotlight)
      const flashlight = new THREE.SpotLight(0xffffff, 1, 20, Math.PI / 6, 0.5);
      flashlight.position.set(0, 1.5, 0);
      flashlight.target.position.set(0, 0, -5);
      flashlight.castShadow = true;
      scene.add(flashlight);
      scene.add(flashlight.target);

      // Niebla para ambiente tenebroso
      scene.fog = new THREE.FogExp2(0x111122, 0.03);

      // Suelo
      const suelo = new THREE.Mesh(
        new THREE.PlaneGeometry(200, 200),
        new THREE.MeshStandardMaterial({ 
          color: 0x114411,
          roughness: 0.8,
          metalness: 0.2
        })
      );
      suelo.rotation.x = -Math.PI / 2;
      suelo.receiveShadow = true;
      scene.add(suelo);

      // Calle principal
      const calle = new THREE.Mesh(
        new THREE.PlaneGeometry(15, 100),
        new THREE.MeshStandardMaterial({ 
          color: 0x111111,
          roughness: 0.9
        })
      );
      calle.rotation.x = -Math.PI / 2;
      calle.position.y = 0.01;
      calle.position.z = -30;
      scene.add(calle);

      // Crear personaje seleccionado
      personaje = new THREE.Mesh(
        new THREE.BoxGeometry(1, 1.8, 1),
        new THREE.MeshStandardMaterial({ 
          color: new THREE.Color(colorPersonaje),
          roughness: 0.7,
          metalness: 0.3
        })
      );
      personaje.position.set(0, 0.9, 0);
      personaje.castShadow = true;
      personaje.receiveShadow = true;
      scene.add(personaje);

      // Cargar mesón
      // Cargar mesón
      // Cargar mesón
      function cargarOBJDePrueba() {
        const objLoader = new THREE.OBJLoader();
        
        // Usar un modelo OBJ público de prueba
        objLoader.load(
          './obj/meson1.obj',
          (object) => {
            meson = object;
            meson.position.set(-12, 0, 0);
            meson.scale.set(0.01, 0.01, 0.01);
            meson.rotation.set(0, Math.PI / 2, 0); // Rotación de 90° en eje Y

            // Aplicar material básico
            meson.traverse(function(child) {
              if (child.isMesh) {
                child.material = new THREE.MeshStandardMaterial({
                  color: 0xaaaaaa,
                  roughness: 0.8,
                  metalness: 0.2
                });
                child.castShadow = true;
                child.receiveShadow = true;
              }
            });
            
            scene.add(meson);
            console.log("Modelo OBJ de prueba cargado correctamente");
          },
          undefined,
          (error) => {
            console.error('Error al cargar OBJ de prueba:', error);
            cargarModeloAlternativo(); // Fallback a modelo básico
          }
        );
      }


      function cargarModeloAlternativo() {
        // Crear una geometría de caja como modelo alternativo
        const geometry = new THREE.BoxGeometry(2, 2, 2);
        const material = new THREE.MeshStandardMaterial({ 
          color: 0x00ff00,
          roughness: 0.7,
          metalness: 0.3
        });
        
        meson = new THREE.Mesh(geometry, material);
        meson.position.set(0, 1, -10);
        meson.castShadow = true;
        meson.receiveShadow = true;
        scene.add(meson);
        
        console.log("Modelo alternativo cargado (caja verde)");
      }

      cargarOBJDePrueba();

      // --- LETRERO ---
      function crearLetrero() {
        const grupo = new THREE.Group();
        
        // Base del letrero
        const baseLetrero = new THREE.Mesh(
          new THREE.BoxGeometry(7, 1, 0.5),
          new THREE.MeshStandardMaterial({ 
            color: 0x222222,
            metalness: 0.7, 
            roughness: 0.8
          })
        );
        baseLetrero.position.set(0, 3, -5);
        grupo.add(baseLetrero);

        // Soportes oxidados
        const soporteGeom = new THREE.BoxGeometry(0.2, 3, 0.2);
        const soporteMaterial = new THREE.MeshStandardMaterial({ 
          color: 0x553333,
          metalness: 0.5,
          roughness: 0.7
        });
        
        const soporte1 = new THREE.Mesh(soporteGeom, soporteMaterial);
        soporte1.position.set(-2.7, 1.5, -5);
        grupo.add(soporte1);

        const soporte2 = soporte1.clone();
        soporte2.position.set(2.7, 1.5, -5);
        grupo.add(soporte2);

        // Texto sangriento
        const canvas = document.createElement('canvas');
        canvas.width = 533;
        canvas.height = 128;
        const context = canvas.getContext('2d');
        
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.font = 'Bold 48px Arial';
        context.fillStyle = '#ff0000';
        context.textAlign = 'center';
        context.shadowColor = 'black';
        context.shadowBlur = 5;
        
        // Efecto de sangre goteando
        context.fillText('LANCO HILL', canvas.width/2, 80);
        for (let i = 0; i < 10; i++) {
          const x = canvas.width/2 - 50 + Math.random() * 100;
          const h = 10 + Math.random() * 20;
          context.fillRect(x, 85, 1 + Math.random() * 2, h);
        }

        const texturaTexto = new THREE.CanvasTexture(canvas);
        const textoGeom = new THREE.PlaneGeometry(5, 1.2);
        const textoMaterial = new THREE.MeshBasicMaterial({ 
          map: texturaTexto,
          transparent: true
        });
        const textoMesh = new THREE.Mesh(textoGeom, textoMaterial);
        textoMesh.position.set(0, 3, -4.74);
        grupo.add(textoMesh);

        return grupo;
      }

      scene.add(crearLetrero());

      // --- CASA PEQUEÑA (abandonada) ---
      function crearCasaPequeña() {
        const grupo = new THREE.Group();
        
        const casaBase = new THREE.Mesh(
          new THREE.BoxGeometry(3, 2, 3),
          new THREE.MeshStandardMaterial({ 
            color: 0x553322,
            roughness: 0.9
          })
        );
        casaBase.position.set(-6, 1, -4);
        grupo.add(casaBase);

        // Ventanas rotas
        for (let i = 0; i < 4; i++) {
          const ventana = new THREE.Mesh(
            new THREE.PlaneGeometry(0.8, 0.8),
            new THREE.MeshStandardMaterial({
              color: 0x000000,
              emissive: 0x111111,
              emissiveIntensity: 0.2,
              side: THREE.DoubleSide
            })
          );
          ventana.position.set(
            -6 + (i % 2 ? 1 : -1) * 1.2,
            1.5,
            -4 + (i < 2 ? 1 : -1) * 1.2
          );
          ventana.rotation.y = i % 2 ? Math.PI / 2 : 0;
          grupo.add(ventana);
        }

        const techoGeom = new THREE.ConeGeometry(2, 1, 4);
        const techoMaterial = new THREE.MeshStandardMaterial({ 
          color: 0x990000,
          roughness: 0.8
        });
        const techo = new THREE.Mesh(techoGeom, techoMaterial);
        techo.position.set(-6, 3, -4);
        techo.rotation.y = Math.PI / 4;
        grupo.add(techo);

        return grupo;
      }

      scene.add(crearCasaPequeña());

      // --- MUNICIPALIDAD (edificio rectangular gris) ---
      function crearMunicipalidad() {
        const grupo = new THREE.Group();
        
        const base = new THREE.Mesh(
          new THREE.BoxGeometry(8, 5, 12),
          new THREE.MeshStandardMaterial({ 
            color: 0x777777,
            roughness: 0.8
          })
        );
        base.position.set(15, 2.5, -20);
        grupo.add(base);

        // Columnas
        const columnaGeom = new THREE.CylinderGeometry(0.3, 0.3, 6, 8);
        const columnaMaterial = new THREE.MeshStandardMaterial({ 
          color: 0x999999,
          metalness: 0.3
        });
        
        for (let i = 0; i < 4; i++) {
          const columna = new THREE.Mesh(columnaGeom, columnaMaterial);
          columna.position.set(
            15 + (i % 2 ? 3 : -3),
            3,
            -20 + (i < 2 ? 4 : -4)
          );
          grupo.add(columna);
        }

        // Escaleras
        const escaleraGeom = new THREE.BoxGeometry(10, 0.5, 2);
        const escaleraMaterial = new THREE.MeshStandardMaterial({ 
          color: 0x555555
        });
        
        for (let i = 0; i < 3; i++) {
          const escalera = new THREE.Mesh(escaleraGeom, escaleraMaterial);
          escalera.position.set(
            15,
            i * 0.5,
            -20 + 6 + i * 0.5
          );
          grupo.add(escalera);
        }

        // Letrero "MUNICIPALIDAD"
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 128;
        const context = canvas.getContext('2d');
        
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.font = 'Bold 32px Arial';
        context.fillStyle = '#ffffff';
        context.textAlign = 'center';
        context.fillText('MUNICIPALIDAD', canvas.width/2, 70);

        const texturaTexto = new THREE.CanvasTexture(canvas);
        const textoGeom = new THREE.PlaneGeometry(6, 1.5);
        const textoMaterial = new THREE.MeshBasicMaterial({ 
          map: texturaTexto,
          transparent: true,
          side: THREE.DoubleSide
        });
        const textoMesh = new THREE.Mesh(textoGeom, textoMaterial);
        textoMesh.position.set(15, 6, -20);
        textoMesh.rotation.y = Math.PI;
        grupo.add(textoMesh);

        return grupo;
      }

      scene.add(crearMunicipalidad());

      // --- TEATRO GALIA (edificio antiguo amarillo) ---
      function crearTeatroGalia() {
        const grupo = new THREE.Group();
        
        const base = new THREE.Mesh(
          new THREE.BoxGeometry(10, 6, 8),
          new THREE.MeshStandardMaterial({ 
            color: 0xddbb55,
            roughness: 0.7
          })
        );
        base.position.set(-15, 3, -15);
        grupo.add(base);

        // Fachada decorada
        const fachadaGeom = new THREE.BoxGeometry(10, 2, 0.2);
        const fachadaMaterial = new THREE.MeshStandardMaterial({ 
          color: 0xeecc66,
          roughness: 0.5
        });
        const fachada = new THREE.Mesh(fachadaGeom, fachadaMaterial);
        fachada.position.set(-15, 7, -11);
        grupo.add(fachada);

        // Letrero "TEATRO GALIA"
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 128;
        const context = canvas.getContext('2d');
        
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.font = 'Bold 28px Arial';
        context.fillStyle = '#aa0000';
        context.textAlign = 'center';
        context.fillText('TEATRO GALIA', canvas.width/2, 70);

        const texturaTexto = new THREE.CanvasTexture(canvas);
        const textoGeom = new THREE.PlaneGeometry(8, 1.2);
        const textoMaterial = new THREE.MeshBasicMaterial({ 
          map: texturaTexto,
          transparent: true,
          side: THREE.DoubleSide
        });
        const textoMesh = new THREE.Mesh(textoGeom, textoMaterial);
        textoMesh.position.set(-15, 8, -10.9);
        grupo.add(textoMesh);

        return grupo;
      }

      scene.add(crearTeatroGalia());

      // --- IGLESIA (amarilla con cruz) ---
      function crearIglesia() {
        const grupo = new THREE.Group();
        
        const base = new THREE.Mesh(
          new THREE.BoxGeometry(6, 8, 12),
          new THREE.MeshStandardMaterial({ 
            color: 0xddcc88,
            roughness: 0.7
          })
        );
        base.position.set(0, 4, -30);
        grupo.add(base);

        // Torre
        const torre = new THREE.Mesh(
          new THREE.BoxGeometry(2, 12, 2),
          new THREE.MeshStandardMaterial({ 
            color: 0xeecc99
          })
        );
        torre.position.set(0, 10, -30);
        grupo.add(torre);

        // Cruz
        const cruzVertical = new THREE.Mesh(
          new THREE.BoxGeometry(0.3, 2, 0.3),
          new THREE.MeshStandardMaterial({ 
            color: 0x333333
          })
        );
        cruzVertical.position.set(0, 16, -30);
        grupo.add(cruzVertical);

        const cruzHorizontal = new THREE.Mesh(
          new THREE.BoxGeometry(1.5, 0.3, 0.3),
          new THREE.MeshStandardMaterial({ 
            color: 0x333333
          })
        );
        cruzHorizontal.position.set(0, 15.5, -30);
        grupo.add(cruzHorizontal);

        // Puerta
        const puerta = new THREE.Mesh(
          new THREE.BoxGeometry(2, 3, 0.2),
          new THREE.MeshStandardMaterial({ 
            color: 0x553311
          })
        );
        puerta.position.set(0, 1.5, -24.1);
        grupo.add(puerta);

        return grupo;
      }

      scene.add(crearIglesia());

      // --- RADIO FRATERNA ---
      function crearRadioFraterna() {
        const grupo = new THREE.Group();
        
        const base = new THREE.Mesh(
          new THREE.BoxGeometry(5, 4, 5),
          new THREE.MeshStandardMaterial({ 
            color: 0xaa6666,
            roughness: 0.8
          })
        );
        base.position.set(10, 2, 10);
        grupo.add(base);

        // Antena
        const antenaBase = new THREE.Mesh(
          new THREE.CylinderGeometry(0.5, 0.5, 1, 8),
          new THREE.MeshStandardMaterial({ 
            color: 0x777777
          })
        );
        antenaBase.position.set(10, 4.5, 10);
        grupo.add(antenaBase);

        const antena = new THREE.Mesh(
          new THREE.CylinderGeometry(0.1, 0.1, 8, 8),
          new THREE.MeshStandardMaterial({ 
            color: 0x999999,
            metalness: 0.5
          })
        );
        antena.position.set(10, 9, 10);
        grupo.add(antena);

        // Letrero "RADIO FRATERNA"
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 128;
        const context = canvas.getContext('2d');
        
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.font = 'Bold 24px Arial';
        context.fillStyle = '#ffffff';
        context.textAlign = 'center';
        context.fillText('RADIO FRATERNA', canvas.width/2, 70);

        const texturaTexto = new THREE.CanvasTexture(canvas);
        const textoGeom = new THREE.PlaneGeometry(4, 0.8);
        const textoMaterial = new THREE.MeshBasicMaterial({ 
          map: texturaTexto,
          transparent: true,
          side: THREE.DoubleSide
        });
        const textoMesh = new THREE.Mesh(textoGeom, textoMaterial);
        textoMesh.position.set(10, 5, 7.6);
        grupo.add(textoMesh);

        return grupo;
      }

      scene.add(crearRadioFraterna());

      // --- PILETA ---
      function crearPileta() {
        const grupo = new THREE.Group();
        
        // Base de la pileta
        const base = new THREE.Mesh(
          new THREE.CylinderGeometry(3, 3, 0.5, 32),
          new THREE.MeshStandardMaterial({ 
            color: 0x777777,
            roughness: 0.7
          })
        );
        base.position.set(-10, 0.25, 10);
        grupo.add(base);

        // Agua
        const agua = new THREE.Mesh(
          new THREE.CylinderGeometry(2.8, 2.8, 0.2, 32),
          new THREE.MeshStandardMaterial({ 
            color: 0x3366aa,
            transparent: true,
            opacity: 0.8,
            roughness: 0.1,
            metalness: 0.7
          })
        );
        agua.position.set(-10, 0.45, 10);
        grupo.add(agua);

        // Fuente central
        const fuente = new THREE.Mesh(
          new THREE.CylinderGeometry(0.3, 0.5, 1, 8),
          new THREE.MeshStandardMaterial({ 
            color: 0xcccccc,
            metalness: 0.5
          })
        );
        fuente.position.set(-10, 1, 10);
        grupo.add(fuente);

        return grupo;
      }

      scene.add(crearPileta());

      // --- Movimiento personaje ---
      let input = { 
        izquierda: false, 
        derecha: false, 
        adelante: false, 
        atras: false, 
        accion: false,
        camaraIzq: false,
        camaraDer: false,
        camaraArriba: false,
        camaraAbajo: false,
        linterna: false
      };
      const velocidad = 0.1;
      let cameraRotationSpeed = 0;
      const maxCameraRotationSpeed = 0.05;
      const cameraRotationAcceleration = 0.001;
      const cameraRotationDeceleration = 0.005;
      const cameraPitchSpeed = 0.01;
      const minPitch = 0.1;
      const maxPitch = 6;

      function moverPersonaje() {
        const now = Date.now();
        
        // Movimiento relativo a la dirección de la cámara
        const forwardX = Math.sin(cameraAngle);
        const forwardZ = Math.cos(cameraAngle);
        
        if (input.adelante) {
          personaje.position.x += forwardX * velocidad;
          personaje.position.z += forwardZ * velocidad;
          if (now - lastMoveSoundTime > moveSoundCooldown) {
            soundGenerator.playMove();
            lastMoveSoundTime = now;
          }
        }
        if (input.atras) {
          personaje.position.x -= forwardX * velocidad;
          personaje.position.z -= forwardZ * velocidad;
          if (now - lastMoveSoundTime > moveSoundCooldown) {
            soundGenerator.playMove();
            lastMoveSoundTime = now;
          }
        }
        if (input.izquierda) {
          personaje.position.x -= forwardZ * velocidad;
          personaje.position.z += forwardX * velocidad;
          if (now - lastMoveSoundTime > moveSoundCooldown) {
            soundGenerator.playMove();
            lastMoveSoundTime = now;
          }
        }
        if (input.derecha) {
          personaje.position.x += forwardZ * velocidad;
          personaje.position.z -= forwardX * velocidad;
          if (now - lastMoveSoundTime > moveSoundCooldown) {
            soundGenerator.playMove();
            lastMoveSoundTime = now;
          }
        }
        if (input.accion) {
          soundGenerator.playAction();
          console.log("Acción A");
        }
        
        // Rotación de cámara horizontal con aceleración/suavizado
        if (input.camaraIzq) {
          cameraRotationSpeed = Math.min(cameraRotationSpeed + cameraRotationAcceleration, maxCameraRotationSpeed);
        } else if (input.camaraDer) {
          cameraRotationSpeed = Math.max(cameraRotationSpeed - cameraRotationAcceleration, -maxCameraRotationSpeed);
        } else {
          // Deceleración cuando no hay input
          if (cameraRotationSpeed > 0) {
            cameraRotationSpeed = Math.max(0, cameraRotationSpeed - cameraRotationDeceleration);
          } else if (cameraRotationSpeed < 0) {
            cameraRotationSpeed = Math.min(0, cameraRotationSpeed + cameraRotationDeceleration);
          }
        }
        
        cameraAngle += cameraRotationSpeed;
        
        // Rotación de cámara vertical
        if (input.camaraArriba) {
          cameraPitch = Math.min(cameraPitch + cameraPitchSpeed, maxPitch);
        }
        if (input.camaraAbajo) {
          cameraPitch = Math.max(cameraPitch - cameraPitchSpeed, minPitch);
        }
        
        // Linterna
        if (input.linterna) {
          flashlightEnabled = !flashlightEnabled;
          input.linterna = false; // Para que no siga alternando
          flashlight.intensity = flashlightEnabled ? 1 : 0;
        }
      }

      // Controles
      ['izquierda', 'derecha', 'adelante', 'atras', 'accion', 'camara-izq', 'camara-der', 'camara-arriba', 'camara-abajo', 'linterna'].forEach(b => {
        const id = b === 'camara-izq' ? 'camaraIzq' : 
                  b === 'camara-der' ? 'camaraDer' :
                  b === 'camara-arriba' ? 'camaraArriba' :
                  b === 'camara-abajo' ? 'camaraAbajo' : b;
        
        document.getElementById(b).addEventListener('touchstart', () => input[id] = true);
        document.getElementById(b).addEventListener('touchend', () => input[id] = false);
        document.getElementById(b).addEventListener('touchcancel', () => input[id] = false);
      });

      window.addEventListener('keydown', e => {
        if (e.key === 'ArrowUp') input.adelante = true;
        if (e.key === 'ArrowDown') input.atras = true;
        if (e.key === 'ArrowLeft') input.izquierda = true;
        if (e.key === 'ArrowRight') input.derecha = true;
        if (e.key.toLowerCase() === 'e') input.accion = true;
        if (e.key === 'a') input.camaraIzq = true;
        if (e.key === 'd') input.camaraDer = true;
        if (e.key === 'w') input.camaraArriba = true;
        if (e.key === 's') input.camaraAbajo = true;
        if (e.key.toLowerCase() === 'r') input.linterna = true;
      });

      window.addEventListener('keyup', e => {
        if (e.key === 'ArrowUp') input.adelante = false;
        if (e.key === 'ArrowDown') input.atras = false;
        if (e.key === 'ArrowLeft') input.izquierda = false;
        if (e.key === 'ArrowRight') input.derecha = false;
        if (e.key.toLowerCase() === 'e') input.accion = false;
        if (e.key === 'a') input.camaraIzq = false;
        if (e.key === 'd') input.camaraDer = false;
        if (e.key === 'w') input.camaraArriba = false;
        if (e.key === 's') input.camaraAbajo = false;
        if (e.key.toLowerCase() === 'r') input.linterna = false;
      });

      // Animación
      function animar() {
        requestAnimationFrame(animar);
        moverPersonaje();
        
        // Actualizar posición de la cámara para seguir al personaje en tercera persona
        const horizontalDistance = Math.cos(cameraPitch) * cameraDistance;
        const verticalDistance = Math.sin(cameraPitch) * cameraDistance;
        
        camera.position.x = personaje.position.x + Math.sin(cameraAngle) * horizontalDistance;
        camera.position.y = personaje.position.y + cameraHeight + verticalDistance;
        camera.position.z = personaje.position.z + Math.cos(cameraAngle) * horizontalDistance;
        
        // Hacer que la cámara mire al personaje
        camera.lookAt(personaje.position);
        
        // Actualizar posición de la linterna
        flashlight.position.set(personaje.position.x, personaje.position.y + 1.5, personaje.position.z);
        flashlight.target.position.set(
          personaje.position.x + Math.sin(cameraAngle) * 5,
          personaje.position.y,
          personaje.position.z + Math.cos(cameraAngle) * 5
        );
        
        renderer.render(scene, camera);
      }

      animar();

      // Manejar cambios de orientación y redimensionamiento
      window.addEventListener('resize', handleOrientationChange);
      window.addEventListener('orientationchange', handleOrientationChange);
      handleOrientationChange();
    }
  </script>
</body>
</html>
